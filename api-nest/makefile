# Makefile para automaÃ§Ã£o do projeto Open Banking API

# Cores para output
VERDE=\033[0;32m
AMARELO=\033[1;33m
VERMELHO=\033[0;31m
NC=\033[0m

# VariÃ¡veis
DOCKER_COMPOSE = docker compose
PROJECT_LABEL = com.docker.compose.project=open-banking-api
APP_LABEL = app=open-banking
SERVICO_APP = app
SERVICO_DB = db
SCRIPT_MIGRACAO = /app/scripts/run-migrations.js

.PHONY: ajuda verificar-dependencias iniciar limpar construir iniciar-app parar logs migrar verificar-saude verificar-banco testar listar-recursos

ajuda:
	@echo "$(AMARELO)âš™ï¸  Comandos disponÃ­veis:$(NC)"
	@echo "$(VERDE)make verificar-dependencias$(NC) - Verifica dependÃªncias"
	@echo "$(VERDE)make listar-recursos$(NC)    - Lista recursos do projeto"
	@echo "$(VERDE)make iniciar$(NC)            - Inicializa o projeto completo"
	@echo "$(VERDE)make limpar$(NC)             - Limpa APENAS recursos do projeto"
	@echo "$(VERDE)make construir$(NC)          - ConstrÃ³i as imagens Docker"
	@echo "$(VERDE)make start$(NC)              - Inicia a aplicaÃ§Ã£o"
	@echo "$(VERDE)make iniciar-app$(NC)        - Inicia a aplicaÃ§Ã£o"
	@echo "$(VERDE)make parar$(NC)              - Para a aplicaÃ§Ã£o"
	@echo "$(VERDE)make logs$(NC)               - Mostra logs da aplicaÃ§Ã£o"
	@echo "$(VERDE)make migrar$(NC)             - Executa migraÃ§Ãµes do banco"
	@echo "$(VERDE)make verificar-saude$(NC)    - Verifica saÃºde da aplicaÃ§Ã£o"
	@echo "$(VERDE)make verificar-banco$(NC)    - Verifica estado do banco"
	@echo "$(VERDE)make testar$(NC)             - Testa endpoints da API"

verificar-dependencias:
	@echo "$(AMARELO)ğŸ” Verificando dependÃªncias...$(NC)"
	@which make >/dev/null && echo "$(VERDE)âœ… Make instalado$(NC)" || (echo "$(VERMELHO)âŒ Make nÃ£o instalado$(NC)" && exit 1)
	@which docker >/dev/null && echo "$(VERDE)âœ… Docker instalado$(NC)" || (echo "$(VERMELHO)âŒ Docker nÃ£o instalado$(NC)" && exit 1)
	@docker compose version >/dev/null 2>&1 && echo "$(VERDE)âœ… Docker Compose instalado$(NC)" || (echo "$(VERMELHO)âŒ Docker Compose nÃ£o instalado$(NC)" && exit 1)
	@echo "$(VERDE)âœ… Todas as dependÃªncias estÃ£o instaladas!$(NC)"

listar-recursos:
	@echo "$(AMARELO)ğŸ“‹ Containers do projeto:$(NC)"
	@docker ps -a --filter "label=${PROJECT_LABEL}" --format "table {{.ID}}\t{{.Names}}\t{{.Status}}\t{{.Ports}}"
	@echo ""
	@echo "$(AMARELO)ğŸ“¦ Imagens do projeto:$(NC)"
	@docker images --filter "label=${PROJECT_LABEL}" --format "table {{.ID}}\t{{.Repository}}\t{{.Tag}}\t{{.Size}}"
	@echo ""
	@echo "$(AMARELO)ğŸ’¾ Volumes do projeto:$(NC)"
	@docker volume ls --filter "label=${PROJECT_LABEL}" --format "table {{.Name}}\t{{.Driver}}\t{{.Scope}}"
	@echo ""
	@echo "$(AMARELO)ğŸŒ Networks do projeto:$(NC)"
	@docker network ls --filter "label=${PROJECT_LABEL}" --format "table {{.ID}}\t{{.Name}}\t{{.Driver}}"

start: iniciar-app

iniciar: verificar-dependencias limpar construir iniciar-app migrar
	@echo "$(VERDE)âœ… Projeto inicializado com sucesso!$(NC)"
	@echo "$(AMARELO)ğŸ“š URLs disponÃ­veis:$(NC)"
	@echo "Swagger UI: http://localhost:3000/api/v1/docs"
	@echo "PGAdmin: http://localhost:5050"
	@echo "Health Check: http://localhost:3000/api/v1/health"

limpar:
	@echo "$(AMARELO)ğŸ§¹ Removendo APENAS recursos do projeto...$(NC)"
	
	@echo "$(AMARELO)ğŸ›‘ Parando containers...$(NC)"
	@docker ps -q --filter "label=${PROJECT_LABEL}" | xargs -r docker stop 2>/dev/null || true
	
	@echo "$(AMARELO)ğŸ—‘ï¸  Removendo containers...$(NC)"
	@docker ps -a -q --filter "label=${PROJECT_LABEL}" | xargs -r docker rm 2>/dev/null || true
	
	@echo "$(AMARELO)ğŸ—‘ï¸  Removendo imagens...$(NC)"
	@docker images -q --filter "label=${PROJECT_LABEL}" | xargs -r docker rmi -f 2>/dev/null || true
	
	@echo "$(AMARELO)ğŸ—‘ï¸  Removendo volumes...$(NC)"
	@docker volume ls -q --filter "label=${PROJECT_LABEL}" | xargs -r docker volume rm -f 2>/dev/null || true
	
	@echo "$(AMARELO)ğŸ—‘ï¸  Removendo networks...$(NC)"
	@docker network ls -q --filter "label=${PROJECT_LABEL}" | xargs -r docker network rm 2>/dev/null || true
	
	@echo "$(AMARELO)ğŸ§¹ Removendo artefatos do projeto...$(NC)"
	sudo rm -rf dist node_modules yarn.lock package-lock.json .env.local
	@echo "$(VERDE)âœ… Limpeza especÃ­fica do projeto concluÃ­da!$(NC)"

dependencias:
	@echo "$(AMARELO)ğŸ“¦ Instalando dependÃªncias...$(NC)"
	yarn install
	@echo "$(VERDE)âœ… DependÃªncias instaladas!$(NC)"

construir: dependencias
	@echo "$(AMARELO)ğŸ—ï¸  Construindo projeto...$(NC)"
	yarn build
	@echo "$(AMARELO)ğŸ³ Construindo imagens Docker...$(NC)"
	$(DOCKER_COMPOSE) build --no-cache
	@echo "$(VERDE)âœ… Build concluÃ­do!$(NC)"

iniciar-app:
	@echo "$(AMARELO)ğŸš€ Iniciando aplicaÃ§Ã£o...$(NC)"
	$(DOCKER_COMPOSE) up -d
	@echo "$(VERDE)âœ… AplicaÃ§Ã£o iniciada!$(NC)"
	@echo "$(AMARELO)â³ Aguardando aplicaÃ§Ã£o ficar disponÃ­vel...$(NC)"
	sleep 10

parar:
	@echo "$(AMARELO)ğŸ›‘ Parando aplicaÃ§Ã£o...$(NC)"
	$(DOCKER_COMPOSE) down
	@echo "$(VERDE)âœ… AplicaÃ§Ã£o parada!$(NC)"

logs:
	@echo "$(AMARELO)ğŸ“‹ Mostrando logs...$(NC)"
	$(DOCKER_COMPOSE) logs -f $(SERVICO_APP)

migrar:
	@echo "$(AMARELO)ğŸ”„ Verificando script de migraÃ§Ã£o...$(NC)"
	$(DOCKER_COMPOSE) exec $(SERVICO_APP) ls -la /app/scripts/
	@echo "$(AMARELO)ğŸ—„ï¸  Executando migraÃ§Ãµes...$(NC)"
	$(DOCKER_COMPOSE) run --rm $(SERVICO_APP) node $(SCRIPT_MIGRACAO)
	@echo "$(VERDE)âœ… MigraÃ§Ãµes executadas!$(NC)"

verificar-saude:
	@echo "$(AMARELO)â¤ï¸  Verificando saÃºde da aplicaÃ§Ã£o...$(NC)"
	curl -f http://localhost:3000/api/v1/health || \
	(echo "$(VERMELHO)âŒ Health check falhou!$(NC)" && exit 1)
	@echo "$(VERDE)âœ… Health check OK!$(NC)"

verificar-banco:
	@echo "$(AMARELO)ğŸ“Š Verificando migraÃ§Ãµes no banco...$(NC)"
	$(DOCKER_COMPOSE) exec $(SERVICO_DB) psql -U postgres -d open_banking -c "SELECT * FROM migrations;"
	@echo "$(AMARELO)ğŸ“‹ Verificando tabelas...$(NC)"
	$(DOCKER_COMPOSE) exec $(SERVICO_DB) psql -U postgres -d open_banking -c "\dt"

testar: verificar-saude
	@echo "$(AMARELO)ğŸ§ª Testando endpoints...$(NC)"
	curl -s http://localhost:3000/api/v1/health | grep -q "status" && \
	echo "$(VERDE)âœ… Health endpoint OK!$(NC)" || \
	(echo "$(VERMELHO)âŒ Health endpoint falhou!$(NC)" && exit 1)
	@echo "$(VERDE)âœ… Todos os testes passaram!$(NC)"